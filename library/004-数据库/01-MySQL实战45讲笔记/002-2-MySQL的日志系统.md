## 02 | 日志系统
一条查询语句的执行过程一般是经过连接器、查询缓存、分析器、优化器、执行器这几个功能模块，最后到达存储引擎。
而当执行一条更新语句的时候，经过查询缓存时，这个表有关的查询缓存都会失效，所以这条语句就会把表T上所有缓存结果都清空。
接下来，分析器会通过词法和语法解析知道这是一条更新语句。优化器决定使用哪个索引。执行器负责具体执行。

与查询流程不一样的是，更新流程还涉及两个重要的日志模块，它们正是我们今天要讨论的主题：redo log(重做日志)和binlog(归档日志)。

### 重要的日志模块：redo log
还记得《孔乙己》这篇文章吗，酒店掌柜有一个粉板，专门用来记录客人的赊账记录。如果赊账的人不多，那么他可以把顾客名和账目写在板上。如果赊账的人多了，粉板总会有记不下的时候，这个时候掌柜一定有一个专门记录赊账的账本。
如果有人要赊账或者还账的话，掌柜一般有两种做法：
- 直接把账本翻出来，把这次赊的账加上去或者扣除掉。
- 现在粉板上记下这次的账，等打烊以后再把账本翻出来核算。
在生意红火柜台很忙时，掌柜一定会选择后者，因为前者操作实在是太麻烦了。首先要找到这个人的赊账总额那条记录，找到之后再拿出算盘计算，最后再将结果写回到账本上。相比之下，还是先在粉板上记录一下方便。如果没有粉板帮助，每次记账都要翻账本，效率是不是低的难以忍受？

同样的，在MySQL里也有这个问题，如果每一次的更新操作都需要写进磁盘，然后磁盘也要找到对应的那条记录，然后在更新，整个过程的IO成本、查询成本都很高。为了解决这个问题，MySQL的设计者就用了类似酒店掌柜粉板的思路来提升更新效率。
而粉板和账本配合的整个过程，其实就是MySQL里经常说的WAL技术(Write-Ahead Logging)，它的关键点就是先写日志，再写磁盘，也就是先写粉板，等不忙的时候再写账本。具体来说，当有一条记录需要更新的时候，InnoDB引擎就会先把记录写到redo log里面，并更新内存，这个时候更新就算完成了。同时，InnoDB引擎会在适当的时候，将这个操作记录更新到磁盘里面，而这个更新往往是系统比较空闲的时候做，就像是打烊以后掌柜做的事。

如果今天赊账的不多，掌柜可以等打烊后在整理。但如果某天赊账的特别多，粉板写满了，又怎么办呢？这个时候掌柜只好放下手中的活儿，把粉板中的一部分赊账记录更新到账本中，然后把这些记录从粉板上擦掉，为新记账腾出空间。

与此类似，InnoDB的redo log是固定大小的，比如可以配置为一组4个文件，每个文件的大小是1GB，那么这块“粉板”总共就可以记录4GB的操作。从头开始写，写到末尾就又回到开头循环写，如图所示。
![redo log 流程图](https://static001.geekbang.org/resource/image/16/a7/16a7950217b3f0f4ed02db5db59562a7.png)
write pos是当前记录的位置，一边写一遍移动，写到第三号文件末尾就回到0号文件的开头。check point是当前要擦除的位置，也是往后推移并且循环的，擦除记录前要把记录更新到数据文件。

write pos和check point
